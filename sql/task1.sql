drop table if exists employees;

-- INIT database
create table employees (
  id number not null,
  name varchar2(100) not null,
  department_id number not null,
  hire_date date not null
  -- ...   
);

-- Insert Section
INSERT INTO employees(id, name, department_id, hire_date) VALUES (1, 'John', 1, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (2, 'Wick', 1, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (3, 'Wayn', 1, CURRENT_DATE);

INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);
INSERT INTO employees(id, name, department_id, hire_date) VALUES (4, 'EmployeerX', 2, CURRENT_DATE);

-- Если в pl/sql v_result = varchar2(1000), то эта строка переполнит длину склейки
INSERT INTO employees(id, name, department_id, hire_date) VALUES 
(4, 'EmployeerLAST', 2, CURRENT_DATE + 1);

-- QUERY database
-- SELECT * FROM employees;

declare
  -- Нерабочий вариант
  -- v_result varchar2(1000);

  -- Один из возможных простых вариантов 
  -- (при условии, что мы доверяем данным и функция не будет меняться по логике)
  -- Просто увеличиваем допустимое значение с запасом, например, в несколько раз
  -- v_result varchar2(3000);
  
  -- Так же можно изменить тип данных, если есть возможность
  -- Если функция не анонимная, то ее тип может использоваться где-то еще
  -- В местах, где вызывается функция
  v_result clob;
  
  -- И можно дополнительно возвращать чанками (кусочками), если varchar2 критично
  -- 32767 - максимальный размер varchar2
  v_chunk_size constant pls_integer := 32767;
  v_pos pls_integer := 1;
begin
  select listagg(name, ', ')
	within group (order by hire_date)
  into v_result
  from employees
  where department_id = 2;
  
  while v_pos <= dbms_lob.getlength(v_result) loop
    dbms_output.put_line(dbms_lob.substr(v_result, v_chunk_size, v_pos));
    v_pos := v_pos + v_chunk_size;
  end loop;
end;